<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>AR Cube Placer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: -apple-system, sans-serif; }
    #ui {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      z-index: 999;
      pointer-events: none;
    }
    #hint {
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      text-align: center;
      backdrop-filter: blur(6px);
      pointer-events: none;
    }
    #btn-row {
      display: flex;
      gap: 12px;
      pointer-events: all;
    }
    button {
      padding: 14px 24px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(8px);
    }
    #place-btn {
      background: rgba(255,255,255,0.9);
      color: #111;
      min-width: 160px;
    }
    #clear-btn {
      background: rgba(255,80,80,0.85);
      color: #fff;
    }
    #count {
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      pointer-events: none;
    }
    #marker-hint {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 20px 30px;
      border-radius: 16px;
      text-align: center;
      font-size: 15px;
      line-height: 1.6;
      z-index: 1000;
      max-width: 320px;
    }
    #marker-hint h3 { font-size: 18px; margin-bottom: 8px; }
    #marker-hint button {
      margin-top: 14px;
      background: #fff;
      color: #111;
      padding: 10px 28px;
      pointer-events: all;
    }
    .crosshair {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 40px; height: 40px;
      pointer-events: none;
      z-index: 998;
    }
    .crosshair::before, .crosshair::after {
      content: '';
      position: absolute;
      background: rgba(255,255,255,0.8);
    }
    .crosshair::before { width: 2px; height: 40px; left: 50%; top: 0; }
    .crosshair::after { width: 40px; height: 2px; top: 50%; left: 0; }
  </style>
</head>
<body>

<div id="marker-hint">
  <h3>ðŸ“¦ AR Cube Placer</h3>
  <p>Point your camera at a <strong>flat surface</strong> (table or floor).<br><br>
  Tap <strong>"Place Cube"</strong> to drop a cube where the crosshair points.</p>
  <button onclick="document.getElementById('marker-hint').style.display='none'">Got it!</button>
</div>

<div class="crosshair"></div>

<div id="ui">
  <div id="hint">Point at a flat surface and tap Place Cube</div>
  <div id="count">Cubes placed: 0</div>
  <div id="btn-row">
    <button id="place-btn" onclick="placeCube()">ðŸ“¦ Place Cube</button>
    <button id="clear-btn" onclick="clearCubes()">ðŸ—‘ Clear</button>
  </div>
</div>

<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
  renderer="logarithmicDepthBuffer: true; antialias: true;"
  vr-mode-ui="enabled: false"
  style="position:fixed;top:0;left:0;width:100%;height:100%;">

  <!-- Camera -->
  <a-camera
    id="cam"
    gps-camera
    rotation-reader
    look-controls="enabled: false"
    arjs-look-controls="smoothingFactor: 0.1"
    cursor="fuse: false; rayOrigin: mouse">
    <a-cursor color="white" opacity="0.5" scale="0.5 0.5 0.5"></a-cursor>
  </a-camera>

  <!-- Container for placed cubes -->
  <a-entity id="cube-container"></a-entity>

  <!-- Ground reference marker -->
  <a-marker preset="hiro" id="hiro-marker">
    <a-entity id="marker-anchor"></a-entity>
  </a-marker>

</a-scene>

<script>
  let cubeCount = 0;
  let colors = ['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#98D8C8','#F7DC6F'];
  let markerVisible = false;
  let markerPosition = null;

  // Track marker position
  const marker = document.getElementById('hiro-marker');
  marker.addEventListener('markerFound', () => {
    markerVisible = true;
    document.getElementById('hint').textContent = 'âœ… Surface detected! Tap Place Cube';
  });
  marker.addEventListener('markerLost', () => {
    markerVisible = false;
    document.getElementById('hint').textContent = 'Point at a flat surface and tap Place Cube';
  });

  // Fallback: place cube in front of camera if no marker
  function getCameraForwardPosition(distance = 1.5) {
    const cam = document.getElementById('cam');
    const camEl = cam.object3D;
    const dir = new THREE.Vector3(0, 0, -1);
    dir.applyQuaternion(camEl.quaternion);
    dir.y = -0.5; // angle downward
    dir.normalize();
    const pos = camEl.position.clone().addScaledVector(dir, distance);
    return pos;
  }

  function placeCube() {
    const container = document.getElementById('cube-container');
    const cube = document.createElement('a-box');
    const color = colors[cubeCount % colors.length];
    const size = 0.1 + Math.random() * 0.05;

    let pos;

    if (markerVisible) {
      // Place relative to marker
      const markerObj = marker.object3D;
      const worldPos = new THREE.Vector3();
      markerObj.getWorldPosition(worldPos);
      pos = `${worldPos.x.toFixed(3)} ${(worldPos.y + size/2).toFixed(3)} ${worldPos.z.toFixed(3)}`;
    } else {
      // Place in front of camera
      const p = getCameraForwardPosition(1.5 + Math.random() * 0.5);
      pos = `${p.x.toFixed(3)} ${p.y.toFixed(3)} ${p.z.toFixed(3)}`;
    }

    cube.setAttribute('position', pos);
    cube.setAttribute('width', size);
    cube.setAttribute('height', size);
    cube.setAttribute('depth', size);
    cube.setAttribute('color', color);
    cube.setAttribute('material', `color: ${color}; metalness: 0.2; roughness: 0.6; opacity: 0.95`);
    cube.setAttribute('shadow', 'cast: true; receive: true');

    // Animate in
    cube.setAttribute('animation__scale', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 300; easing: easeOutBack');
    cube.setAttribute('animation__rot', `property: rotation; to: 0 ${Math.random()*360} 0; dur: 300; easing: easeOutCubic`);

    container.appendChild(cube);
    cubeCount++;
    document.getElementById('count').textContent = `Cubes placed: ${cubeCount}`;

    // Haptic feedback on mobile
    if (navigator.vibrate) navigator.vibrate(50);

    // Button feedback
    const btn = document.getElementById('place-btn');
    btn.style.background = 'rgba(100,200,100,0.95)';
    btn.textContent = 'âœ“ Placed!';
    setTimeout(() => {
      btn.style.background = 'rgba(255,255,255,0.9)';
      btn.textContent = 'ðŸ“¦ Place Cube';
    }, 600);
  }

  function clearCubes() {
    const container = document.getElementById('cube-container');
    // Animate out then remove
    Array.from(container.children).forEach(el => {
      el.setAttribute('animation__out', 'property: scale; to: 0 0 0; dur: 200; easing: easeInBack');
      setTimeout(() => el.parentNode && el.parentNode.removeChild(el), 220);
    });
    cubeCount = 0;
    document.getElementById('count').textContent = 'Cubes placed: 0';
    if (navigator.vibrate) navigator.vibrate([30,30,30]);
  }

  // Also allow tapping screen to place
  document.querySelector('a-scene').addEventListener('click', (e) => {
    if (e.target.id === 'place-btn' || e.target.id === 'clear-btn') return;
    if (e.target.closest('#ui') || e.target.closest('#marker-hint')) return;
    placeCube();
  });
</script>
</body>
</html>
