<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>AR Cube Placer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ar.js/2.2.2/aframe-ar.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: -apple-system, sans-serif; }
    #ui {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      z-index: 999;
      pointer-events: none;
    }
    #hint {
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      text-align: center;
      backdrop-filter: blur(6px);
      pointer-events: none;
    }
    #btn-row {
      display: flex;
      gap: 12px;
      pointer-events: all;
    }
    button {
      padding: 14px 24px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(8px);
    }
    #place-btn {
      background: rgba(255,255,255,0.9);
      color: #111;
      min-width: 160px;
    }
    #clear-btn {
      background: rgba(255,80,80,0.85);
      color: #fff;
    }
    #help-btn {
      background: rgba(255,255,255,0.3);
      color: #fff;
      padding: 14px 18px;
    }
    #count {
      background: rgba(0,0,0,0.5);
      color: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      pointer-events: none;
    }
    #marker-hint {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 20px 30px;
      border-radius: 16px;
      text-align: center;
      font-size: 15px;
      line-height: 1.6;
      z-index: 1000;
      max-width: 320px;
    }
    #marker-hint h3 { font-size: 18px; margin-bottom: 8px; }
    #marker-hint button {
      margin-top: 14px;
      background: #fff;
      color: #111;
      padding: 10px 28px;
      pointer-events: all;
    }
    #https-warning {
      position: fixed;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(200,60,60,0.9);
      color: #fff;
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 13px;
      text-align: center;
      z-index: 1001;
      max-width: 300px;
      backdrop-filter: blur(6px);
      display: none;
    }
    .crosshair {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 40px; height: 40px;
      pointer-events: none;
      z-index: 998;
    }
    .crosshair::before, .crosshair::after {
      content: '';
      position: absolute;
      background: rgba(255,255,255,0.8);
    }
    .crosshair::before { width: 2px; height: 40px; left: 50%; top: 0; }
    .crosshair::after { width: 40px; height: 2px; top: 50%; left: 0; }
  </style>
</head>
<body>

<div id="https-warning">
  Camera requires HTTPS. Please serve this page over a secure connection.
</div>

<div id="marker-hint">
  <h3>ðŸ“¦ AR Cube Placer</h3>
  <p>Point your camera at a <strong>flat surface</strong> (table or floor).<br><br>
  Tap <strong>"Place Cube"</strong> to drop a cube where the crosshair points.</p>
  <button id="hint-dismiss-btn">Got it!</button>
</div>

<div class="crosshair"></div>

<div id="ui">
  <div id="hint">Point at a flat surface and tap Place Cube</div>
  <div id="count">Cubes placed: 0</div>
  <div id="btn-row">
    <button id="place-btn">ðŸ“¦ Place Cube</button>
    <button id="clear-btn">ðŸ—‘ Clear</button>
    <button id="help-btn">?</button>
  </div>
</div>

<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
  renderer="logarithmicDepthBuffer: true; antialias: true;"
  vr-mode-ui="enabled: false"
  style="position:fixed;top:0;left:0;width:100%;height:100%;">

  <!-- Camera -->
  <a-camera
    id="cam"
    rotation-reader
    look-controls="enabled: false"
    arjs-look-controls="smoothingFactor: 0.1"
    cursor="fuse: false; rayOrigin: mouse">
    <a-cursor color="white" opacity="0.5" scale="0.5 0.5 0.5"></a-cursor>
  </a-camera>

  <!-- Container for placed cubes -->
  <a-entity id="cube-container"></a-entity>

  <!-- Ground reference marker -->
  <a-marker preset="hiro" id="hiro-marker">
    <a-entity id="marker-anchor"></a-entity>
  </a-marker>

</a-scene>

<script>
  const MAX_CUBES = 50;
  let cubeCount = 0;
  const colors = ['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#98D8C8','#F7DC6F'];
  let markerVisible = false;
  let lastPlaceTime = 0;

  // Warn if not on a secure origin (camera won't work over plain HTTP)
  if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
    document.getElementById('https-warning').style.display = 'block';
  }

  // Intro modal: dismiss and re-open
  document.getElementById('hint-dismiss-btn').addEventListener('click', () => {
    document.getElementById('marker-hint').style.display = 'none';
  });
  document.getElementById('help-btn').addEventListener('click', () => {
    document.getElementById('marker-hint').style.display = 'block';
  });

  // Button handlers
  document.getElementById('place-btn').addEventListener('click', placeCube);
  document.getElementById('clear-btn').addEventListener('click', clearCubes);

  // Track marker visibility
  const marker = document.getElementById('hiro-marker');
  marker.addEventListener('markerFound', () => {
    markerVisible = true;
    document.getElementById('hint').textContent = 'âœ… Surface detected! Tap Place Cube';
  });
  marker.addEventListener('markerLost', () => {
    markerVisible = false;
    document.getElementById('hint').textContent = 'Point at a flat surface and tap Place Cube';
  });

  function getCameraForwardPosition(distance = 1.5) {
    if (typeof THREE === 'undefined') return null;
    const cam = document.getElementById('cam');
    const camEl = cam.object3D;
    const dir = new THREE.Vector3(0, 0, -1);
    dir.applyQuaternion(camEl.quaternion);
    dir.y = -0.5;
    dir.normalize();
    return camEl.position.clone().addScaledVector(dir, distance);
  }

  function updateCount() {
    const n = document.getElementById('cube-container').children.length;
    document.getElementById('count').textContent = `Cubes placed: ${n}`;
  }

  function placeCube() {
    const container = document.getElementById('cube-container');

    if (container.children.length >= MAX_CUBES) {
      document.getElementById('hint').textContent = `Max ${MAX_CUBES} cubes reached â€” clear some first`;
      return;
    }

    const cube = document.createElement('a-box');
    const color = colors[cubeCount % colors.length];
    const size = 0.1 + Math.random() * 0.05;

    let pos;

    if (markerVisible) {
      const worldPos = new THREE.Vector3();
      marker.object3D.getWorldPosition(worldPos);
      // Spread cubes around the marker instead of stacking at its origin
      const offsetX = (Math.random() - 0.5) * 0.3;
      const offsetZ = (Math.random() - 0.5) * 0.3;
      pos = `${(worldPos.x + offsetX).toFixed(3)} ${(worldPos.y + size / 2).toFixed(3)} ${(worldPos.z + offsetZ).toFixed(3)}`;
    } else {
      const p = getCameraForwardPosition(1.5 + Math.random() * 0.5);
      if (!p) return;
      pos = `${p.x.toFixed(3)} ${p.y.toFixed(3)} ${p.z.toFixed(3)}`;
    }

    cube.setAttribute('position', pos);
    cube.setAttribute('width', size);
    cube.setAttribute('height', size);
    cube.setAttribute('depth', size);
    cube.setAttribute('color', color);
    cube.setAttribute('material', `color: ${color}; metalness: 0.2; roughness: 0.6; opacity: 0.95`);
    cube.setAttribute('shadow', 'cast: true; receive: true');
    cube.setAttribute('animation__scale', 'property: scale; from: 0 0 0; to: 1 1 1; dur: 300; easing: easeOutBack');
    cube.setAttribute('animation__rot', `property: rotation; to: 0 ${Math.random() * 360} 0; dur: 300; easing: easeOutCubic`);

    container.appendChild(cube);
    cubeCount++;
    updateCount();

    if (navigator.vibrate) navigator.vibrate(50);

    const btn = document.getElementById('place-btn');
    btn.style.background = 'rgba(100,200,100,0.95)';
    btn.textContent = 'âœ“ Placed!';
    setTimeout(() => {
      btn.style.background = 'rgba(255,255,255,0.9)';
      btn.textContent = 'ðŸ“¦ Place Cube';
    }, 600);
  }

  function clearCubes() {
    const container = document.getElementById('cube-container');
    // Snapshot children before any async removal to avoid race if called again quickly
    const children = Array.from(container.children);
    if (children.length === 0) return;
    children.forEach(el => {
      el.setAttribute('animation__out', 'property: scale; to: 0 0 0; dur: 200; easing: easeInBack');
      setTimeout(() => el.parentNode?.removeChild(el), 250);
    });
    // Reset display immediately; DOM children removed after animation
    document.getElementById('count').textContent = 'Cubes placed: 0';
    if (navigator.vibrate) navigator.vibrate([30, 30, 30]);
  }

  // Tap anywhere on the scene to place a cube, debounced to prevent accidental rapid placement
  document.querySelector('a-scene').addEventListener('click', (e) => {
    if (e.target.closest('#ui') || e.target.closest('#marker-hint')) return;
    const now = Date.now();
    if (now - lastPlaceTime < 500) return;
    lastPlaceTime = now;
    placeCube();
  });
</script>
</body>
</html>
